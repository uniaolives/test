#!/bin/bash
# .githooks/pre-commit-rosehip
# AI-enhanced commit message validator with Architectural Integrity checks

echo "üåπ ROSEHIP HOOK: Analisando assinatura cognitiva do commit..."

# 1. CONFIGURA√á√ÉO DO SISTEMA ROSEHIP
ROSEHIP_THRESHOLD=50           # Entropia m√°xima permitida
CRITICAL_ENTROPY=20           # Entropia por arquivo que dispara alerta
TIM_VM_ENDPOINT="http://localhost:8000/cosmic_health"

# 2. FUN√á√ÉO: CALCULAR ENTROPIA DO ARQUIVO
calculate_file_entropy() {
    local file="$1"
    python3 scripts/calculate_entropy.py "$file"
}

# 3. FUN√á√ÉO: DETECTAR PADR√ïES HUMANOS
detect_human_patterns() {
    local file="$1"
    local score=0

    if grep -q "# TODO: refactor\|# FIXME:" "$file" 2>/dev/null; then
        score=$((score + 1))
    fi
    if grep -q "def test_\|test(" "$file" 2>/dev/null; then
        score=$((score + 2))
    fi
    if grep -q "logger.debug\|console.log" "$file" 2>/dev/null; then
        score=$((score + 1))
    fi
    if grep -q "while True:\|goto\|eval(" "$file" 2>/dev/null; then
        score=$((score - 3))
    fi

    echo "$score"
}

# 4. FUN√á√ÉO: CONSULTAR O TIM_VM PARA SA√öDE C√ìSMICA
check_cosmic_health() {
    if curl -s --max-time 1 "$TIM_VM_ENDPOINT" > /dev/null 2>&1; then
        local response=$(curl -s --max-time 1 "$TIM_VM_ENDPOINT")
        local dilation=$(echo "$response" | grep -o '"dilation":[0-9.]*' | cut -d':' -f2)

        if [[ ! -z "$dilation" ]] && (( $(echo "$dilation > 2.5" | bc -l) )); then
            echo "‚ö†Ô∏è  Sistema c√≥smico sob estresse (dilata√ß√£o: $dilation)"
            return 1
        fi
    fi
    return 0
}

# 5. AN√ÅLISE PRINCIPAL
main() {
    local total_entropy=0
    local problematic_files=()
    local human_score_total=0

    local files=$(git diff --cached --name-only --diff-filter=ACM)

    if [ -z "$files" ]; then
        echo "‚úÖ Nenhum arquivo para analisar."
        exit 0
    fi

    # check_cosmic_health || exit 1

    for file in $files; do
        if [ ! -f "$file" ]; then continue; fi

        local entropy=$(calculate_file_entropy "$file")
        total_entropy=$(echo "$total_entropy + $entropy" | bc -l)

        local human_score=$(detect_human_patterns "$file")
        human_score_total=$((human_score_total + human_score))

        if (( $(echo "$entropy > $CRITICAL_ENTROPY" | bc -l) )); then
            problematic_files+=("$file")
        fi
    done

    echo "üìà RESULTADO DA AN√ÅLISE ROSEHIP:"
    echo "   Entropia total: $total_entropy / $ROSEHIP_THRESHOLD"
    echo "   Pontua√ß√£o humana: $human_score_total"

    if (( $(echo "$total_entropy > $ROSEHIP_THRESHOLD" | bc -l) )); then
        echo "‚ùå COMMIT REJEITADO: Entropia muito alta."
        exit 1
    fi

    echo "‚úÖ COMMIT APROVADO pelo Filtro Rosehip"
    exit 0
}

main "$@"
