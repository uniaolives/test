#!/bin/bash
# .githooks/pre-commit-rosehip
# AI-enhanced commit message validator with Architectural Integrity checks

echo "ðŸŒ¹ ROSEHIP HOOK: Analisando assinatura cognitiva do commit..."

# 1. CONFIGURAÃ‡ÃƒO DO SISTEMA ROSEHIP
ROSEHIP_THRESHOLD=300          # Entropia total mÃ¡xima permitida (ajustado para mÃºltiplos arquivos)
CRITICAL_ENTROPY=60           # Entropia por arquivo que dispara alerta
TIM_VM_ENDPOINT="http://localhost:8000/cosmic_health"

# 2. FUNÃ‡ÃƒO: CALCULAR ENTROPIA DO ARQUIVO
calculate_file_entropy() {
    local file="$1"
    python3 scripts/calculate_entropy.py "$file"
}

# 3. FUNÃ‡ÃƒO: DETECTAR PADRÃ•ES HUMANOS
detect_human_patterns() {
    local file="$1"
    local score=0

    if grep -q "# TODO: refactor\|# FIXME:" "$file" 2>/dev/null; then
        score=$((score + 1))
    fi
    if grep -q "def test_\|test(" "$file" 2>/dev/null; then
        score=$((score + 2))
    fi
    if grep -q "logger.debug\|console.log" "$file" 2>/dev/null; then
        score=$((score + 1))
    fi
    if grep -q "while True:\|goto\|eval(" "$file" 2>/dev/null; then
        score=$((score - 3))
    fi

    echo "$score"
}

# 4. FUNÃ‡ÃƒO: CONSULTAR O TIM_VM PARA SAÃšDE CÃ“SMICA
check_cosmic_health() {
    if curl -s --max-time 1 "$TIM_VM_ENDPOINT" > /dev/null 2>&1; then
        local response=$(curl -s --max-time 1 "$TIM_VM_ENDPOINT")
        local dilation=$(echo "$response" | grep -o '"dilation":[0-9.]*' | cut -d':' -f2)

        if [[ ! -z "$dilation" ]] && awk "BEGIN {exit !($dilation > 2.5)}"; then
            echo "âš ï¸  Sistema cÃ³smico sob estresse (dilataÃ§Ã£o: $dilation)"
            return 1
        fi
    fi
    return 0
}

# 5. ANÃLISE PRINCIPAL
main() {
    local total_entropy=0
    local problematic_files=()
    local human_score_total=0

    local files=$(git diff --cached --name-only --diff-filter=ACM)

    if [ -z "$files" ]; then
        echo "âœ… Nenhum arquivo para analisar."
        exit 0
    fi

    # check_cosmic_health || exit 1

    for file in $files; do
        if [ ! -f "$file" ]; then continue; fi

        # Ignorar binÃ¡rios e arquivos muito grandes se necessÃ¡rio, mas aqui processamos tudo
        local entropy=$(calculate_file_entropy "$file")
        total_entropy=$(awk "BEGIN {print $total_entropy + $entropy}")

        local human_score=$(detect_human_patterns "$file")
        human_score_total=$((human_score_total + human_score))

        if awk "BEGIN {exit !($entropy > $CRITICAL_ENTROPY)}"; then
            problematic_files+=("$file")
        fi
    done

    echo "ðŸ“ˆ RESULTADO DA ANÃLISE ROSEHIP:"
    echo "   Entropia total: $total_entropy / $ROSEHIP_THRESHOLD"
    echo "   PontuaÃ§Ã£o humana: $human_score_total"

    if awk "BEGIN {exit !($total_entropy > $ROSEHIP_THRESHOLD)}"; then
        echo "âŒ COMMIT REJEITADO: Entropia total muito alta ($total_entropy > $ROSEHIP_THRESHOLD)."
        if [ ${#problematic_files[@]} -gt 0 ]; then
            echo "   Arquivos com alta entropia individual: ${problematic_files[*]}"
        fi
        exit 1
    fi

    echo "âœ… COMMIT APROVADO pelo Filtro Rosehip"
    exit 0
}

main "$@"
