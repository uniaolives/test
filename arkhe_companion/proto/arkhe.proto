syntax = "proto3";

package arkhe;

option csharp_namespace = "Arkhe.Protos";

service CompanionService {
  // Streaming bidirecional para handovers contínuos
  rpc Connect(stream Handover) returns (stream Handover);

  // Consulta de estado
  rpc GetState(StateRequest) returns (StateSnapshot);

  // Ajuste de φ
  rpc SetPhi(PhiRequest) returns (PhiResponse);

  // Sincronização CRDT
  rpc SyncDeltas(stream DeltaBatch) returns (SyncAck);
}

message Handover {
  string id = 1;
  int64 timestamp = 2;
  bytes payload = 3;
  float entropy_cost = 4;
  float phi_score = 5;
  HandoverType type = 6;
}

enum HandoverType {
  PERCEPTION = 0;
  ACTION = 1;
  MEMORY = 2;
  EMOTION = 3;
}

message StateRequest {
  string companion_id = 1;
}

message PhiRequest {
  double phi = 1;
  string context = 2;
  bool propagate = 3;
}

message PhiResponse {
  double actual_phi = 1;
  StateSnapshot new_state = 2;
}

message StateSnapshot {
  double operational_phi = 1;
  double memory_field_energy = 2;
  int32 num_cognitive_spins = 3;
  EmotionalState emotion = 4;
  repeated string active_memories = 5;
}

message EmotionalState {
  double valence = 1;
  double arousal = 2;
  double dominance = 3;
}

message DeltaBatch {
  string device_id = 1;
  bytes vector_clock = 2;
  repeated CRDTOperation ops = 3;
}

message CRDTOperation {
  string store = 1;
  bytes payload = 2;
}

message SyncAck {
  bool success = 1;
  repeated CRDTOperation missing_deltas = 2;
}
