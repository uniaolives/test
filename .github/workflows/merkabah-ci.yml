name: MERKABAH-CI

on: [push, pull_request]

jobs:
  test-python:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: pip install -r modules/python/requirements.txt
      - run: PYTHONPATH=. pytest modules/python/tests/

  test-rust:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - run: cargo build --manifest-path modules/rust/Cargo.toml
      - run: cargo test --manifest-path modules/rust/Cargo.toml

  test-julia:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: julia-actions/setup-julia@v2
        with:
          version: '1.10'
      - run: |
          julia --project=modules/julia -e '
            using Pkg;
            Pkg.Registry.update();
            Pkg.add(["LinearAlgebra", "DifferentialEquations", "Flux", "Graphs", "GraphNeuralNetworks", "Optim", "Symbolics", "Tullio"]);
            Pkg.instantiate();
            Pkg.test();
          '

  integration:
    runs-on: ubuntu-latest
    needs: [test-python, test-rust, test-julia]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: python tests/integration/test_qhttp.py
