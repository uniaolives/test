version: '3.8'

x-common-env: &common-env
  REDIS_URL: redis://redis:6379
  PARALLAX_CONTROLLER_URL: http://controller:8080
  QHTTP_GATEWAY_URL: http://qhttp-gateway:7070
  NCCL_DEBUG: INFO

services:
  redis:
    image: redis:7-alpine
    container_name: arkhe-redis
    command: redis-server --appendonly yes --maxmemory 2gb
    ports: ["6379:6379"]
    networks: [arkhe-net]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  parallax-controller:
    build:
      context: .
      dockerfile: Dockerfile.arkhe-full
    container_name: parallax-controller
    command: python -m parallax.controller
    environment:
      <<: *common-env
      ROLE: controller
    ports: ["8080:8080"]
    depends_on:
      redis:
        condition: service_healthy
    networks: [arkhe-net]

  qhttp-gateway:
    build:
      context: .
      dockerfile: Dockerfile.arkhe-full
    container_name: qhttp-gateway
    command: python -m qhttp.gateway
    environment:
      <<: *common-env
      ROLE: gateway
      QHTTP_NODES: 3
    ports: ["7070:7070"]
    depends_on: [redis, parallax-controller]
    networks: [arkhe-net]

  arkhe-node-1:
    build:
      context: .
      dockerfile: Dockerfile.arkhe-full
    container_name: arkhe-node-1
    hostname: q1
    command: python -m src.main --mode=worker --node-id=q1
    runtime: nvidia
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    environment:
      <<: *common-env
      NODE_ID: q1
      QHTTP_QUBITS: 20
      ARKHE_AGENTS: 200
      QSHIELD_ENABLED: "true"
    shm_size: 16gb
    depends_on: [qhttp-gateway]
    networks: [arkhe-net]

  arkhe-node-2:
    build:
      context: .
      dockerfile: Dockerfile.arkhe-full
    container_name: arkhe-node-2
    hostname: q2
    command: python -m src.main --mode=worker --node-id=q2
    runtime: nvidia
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    environment:
      <<: *common-env
      NODE_ID: q2
      QHTTP_QUBITS: 20
      ARKHE_AGENTS: 200
      QSHIELD_ENABLED: "true"
    shm_size: 16gb
    depends_on: [qhttp-gateway]
    networks: [arkhe-net]

  arkhe-node-3:
    build:
      context: .
      dockerfile: Dockerfile.arkhe-full
    container_name: arkhe-node-3
    hostname: q3
    command: python -m src.main --mode=worker --node-id=q3
    runtime: nvidia
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    environment:
      <<: *common-env
      NODE_ID: q3
      QHTTP_QUBITS: 20
      ARKHE_AGENTS: 200
      QSHIELD_ENABLED: "true"
    shm_size: 16gb
    depends_on: [qhttp-gateway]
    networks: [arkhe-net]

  arkhe-viz:
    build:
      context: .
      dockerfile: qhttp/viz/Dockerfile.production
    container_name: arkhe-viz
    ports: ["8100:8080"]
    environment:
      <<: *common-env
      ROLE: viz
    volumes:
      - ./qhttp/viz/static:/app/qhttp/viz/static:ro
    depends_on: [redis]
    networks: [arkhe-net]

networks:
  arkhe-net:
    driver: bridge
